<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Three.js 3D cubes</title>
<style>
  body { margin:0; overflow:hidden; }
  canvas { display:block;}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<script src="https://unpkg.com/three@0.137.4/build/three.min.js"></script>

<script>
let moveForward = false;
let moveBackward = false;
let moveLeft = false;
let moveRight = false;

const velocity = new THREE.Vector3();
const direction = new THREE.Vector3();
const speed = 0.5; // 移動速度

// キー操作
document.addEventListener('keydown', (event) => {
  switch(event.code){
    case 'KeyW': moveForward = true; break;
    case 'KeyS': moveBackward = true; break;
    case 'KeyA': moveLeft = true; break;
    case 'KeyD': moveRight = true; break;
  }
});
document.addEventListener('keyup', (event) => {
  switch(event.code){
    case 'KeyW': moveForward = false; break;
    case 'KeyS': moveBackward = false; break;
    case 'KeyA': moveLeft = false; break;
    case 'KeyD': moveRight = false; break;
  }
});

// マウスで回転
let pitch = 0;
let yaw = 0;
let isMouseDown = false;
document.addEventListener('mousedown', () => isMouseDown = true);
document.addEventListener('mouseup', () => isMouseDown = false);
document.addEventListener('mousemove', (event)=>{
  if(!isMouseDown) return;
  yaw   -= event.movementX * 0.002;
  pitch -= event.movementY * 0.002;
  pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
});

// アニメーションループ内で移動
function animate(){
  requestAnimationFrame(animate);

  // 移動方向
  direction.set(0,0,0);
  if(moveForward) direction.z -= 1;
  if(moveBackward) direction.z += 1;
  if(moveLeft) direction.x -= 1;
  if(moveRight) direction.x += 1;
  direction.normalize();

  // カメラ向きに合わせてワールド座標に変換
  const cosYaw = Math.cos(yaw);
  const sinYaw = Math.sin(yaw);
  velocity.x = direction.x * cosYaw - direction.z * sinYaw;
  velocity.z = direction.x * sinYaw + direction.z * cosYaw;

  // 位置更新
  camera.position.x += velocity.x * speed;
  camera.position.z += velocity.z * speed;

  // カメラ回転
  camera.rotation.set(pitch, yaw, 0, 'YXZ');

  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
